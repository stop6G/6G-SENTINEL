<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EU 6G Ecosystem 2022-2024</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- D3.js v7 -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;600&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #050505;
            color: #e2e8f0;
            overflow: hidden;
        }

        h1, h2, h3 {
            font-family: 'Space Grotesk', sans-serif;
        }

        /* Glassmorphism Panels */
        .glass-panel {
            background: rgba(20, 20, 30, 0.6);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.8);
        }

        /* Input Styles */
        .search-input {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            transition: all 0.3s ease;
        }
        .search-input:focus {
            outline: none;
            background: rgba(0, 0, 0, 0.6);
            border-color: #d946ef;
            box-shadow: 0 0 15px rgba(217, 70, 239, 0.2);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #3730a3; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #4f46e5; }

        /* SVG Styles */
        #graph-container {
            width: 100%;
            height: 100%;
            cursor: grab;
            background: radial-gradient(circle at center, #0f172a 0%, #020617 100%);
        }
        #graph-container:active { cursor: grabbing; }

        .node text {
            pointer-events: none;
            text-shadow: 0 2px 4px rgba(0,0,0,0.8);
            font-family: 'Space Grotesk', sans-serif;
        }

        /* Highlight classes */
        .node-highlight circle {
            stroke: #fff;
            stroke-width: 3px;
            filter: drop-shadow(0 0 8px rgba(255, 255, 255, 0.8));
        }
    </style>
</head>
<body class="h-screen w-screen flex flex-col">

    <!-- Floating Header -->
    <header class="absolute top-0 left-0 w-full z-10 p-4 pointer-events-none">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center max-w-7xl mx-auto pointer-events-auto gap-4">
            
            <!-- Logo & Title -->
            <div class="glass-panel px-6 py-3 rounded-2xl flex-shrink-0">
                <h1 class="text-xl md:text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-cyan-400 to-fuchsia-500">
                    EU 6G Ecosystem
                </h1>
                <p class="text-[10px] md:text-xs text-gray-400 font-bold text-fuchsia-200">SNS-JU 2022-2024</p>
            </div>

            <!-- Controls Group -->
            <div class="flex flex-wrap gap-3 items-center bg-gray-900/40 p-2 rounded-2xl backdrop-blur-md border border-white/5">
                
                <!-- Search Bar -->
                <div class="relative group">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <svg class="h-4 w-4 text-gray-400 group-focus-within:text-fuchsia-400 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                        </svg>
                    </div>
                    <input type="text" id="searchInput" list="nodes-datalist" 
                           class="search-input text-sm rounded-xl pl-10 pr-4 py-2 w-48 md:w-64" 
                           placeholder="Search Project or Partner..."
                           onchange="handleSearch(this.value)"
                           onkeydown="if(event.key === 'Enter') handleSearch(this.value)">
                    <datalist id="nodes-datalist"></datalist>
                </div>

                <div class="h-6 w-px bg-gray-700 mx-1"></div>

                <!-- Load File -->
                <label class="cursor-pointer hover:bg-white/10 p-2 rounded-lg transition-colors text-cyan-400" title="Upload CSV">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>
                    <input type="file" id="csvInput" accept=".csv" class="hidden" />
                </label>

                <!-- Reset Zoom -->
                <button onclick="resetZoom()" class="hover:bg-white/10 p-2 rounded-lg transition-colors text-gray-300" title="Reset View">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"/></svg>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Area (Graph) -->
    <div class="flex-1 relative overflow-hidden">
        <div id="graph-container"></div>
        
        <!-- Floating Tooltip (Hover) -->
        <div id="tooltip" class="absolute hidden pointer-events-none bg-black/80 backdrop-blur-md border border-gray-700 p-3 rounded-lg text-sm max-w-xs z-50 shadow-xl"></div>
    </div>

    <!-- Side Panel (Details) -->
    <aside id="details-panel" class="absolute top-24 right-4 w-80 lg:w-96 bottom-6 glass-panel rounded-2xl transform translate-x-[120%] transition-transform duration-500 cubic-bezier(0.34, 1.56, 0.64, 1) flex flex-col z-20 overflow-hidden border-l border-t border-white/10">
        
        <!-- Close Button -->
        <button onclick="closePanel()" class="absolute top-4 right-4 text-gray-400 hover:text-white z-30 bg-black/20 rounded-full p-1 hover:bg-black/40 transition-colors">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>

        <div class="p-6 overflow-y-auto h-full scrollbar-thin">
            <!-- Dynamic Content -->
            <div id="panel-content" class="space-y-6">
                <!-- Filled via JS -->
            </div>
        </div>
    </aside>

    <!-- Legend / Stats Footer -->
    <div class="absolute bottom-6 left-6 pointer-events-none z-10 hidden md:block">
        <div class="glass-panel p-4 rounded-xl pointer-events-auto space-y-2">
            <div class="flex items-center gap-2">
                <span class="w-3 h-3 rounded-full bg-fuchsia-500 shadow-[0_0_10px_#d946ef]"></span>
                <span class="text-xs text-gray-300">Projects (<span id="count-projects">0</span>)</span>
            </div>
            <div class="flex items-center gap-2">
                <span class="w-2 h-2 rounded-full bg-amber-500 shadow-[0_0_8px_#f59e0b]"></span>
                <span class="text-xs text-gray-300">Coordinators (<span id="count-coordinators">0</span>)</span>
            </div>
            <div class="flex items-center gap-2">
                <span class="w-2 h-2 rounded-full bg-cyan-400 shadow-[0_0_8px_#22d3ee]"></span>
                <span class="text-xs text-gray-300">Partners (<span id="count-partners">0</span>)</span>
            </div>
        </div>
    </div>

    <script>
        // --- 1. Config & Initial Data ---
        const width = window.innerWidth;
        const height = window.innerHeight;
        
        // Colors
        const colorProject = "#d946ef"; // Fuchsia
        const colorPartner = "#22d3ee"; // Cyan
        const colorCoordinator = "#f59e0b"; // Amber/Orange
        const colorLink = "#334155";
        
        let simulation, svg, g, link, node, zoom;
        let globalData = { nodes: [], links: [] };

        // Sample Data
        const sampleCSV = `Acrónimo;Coordinador;Partners;Dinero Recibido (€);Descripción;Año
5G-STARDUST;German Aerospace Center;Hispasat, Orange, Thales Alenia;5942337;Satellite and terrestrial networks;2022
6G-BRICKS;Athena Research;Orange, Lenovo, Thales Alenia;8382364;Experimentation;2022
6G-NTN;University of Bologna;Ericsson, Orange, Thales Alenia;4646494;Non-terrestrial components;2022
X-TREME 6G;Stmicroelectronics;Nokia, Politecnico di Milano;9974738;Extreme bands research;2024
XTRUST-6G;Centre for Research;Ericsson, Nokia, Telefónica;7998595;Trust and security;2024`;

        // Utility: Short money format (e.g., 5.9M€)
        const formatMoneyShort = (value) => {
            if (!value) return '';
            if (value >= 1000000) return (value / 1000000).toFixed(1) + 'M€';
            if (value >= 1000) return (value / 1000).toFixed(0) + 'k€';
            return value + '€';
        };

        // --- 2. Data Processing (CSV -> Graph) ---
        function parseCSVAndBuildGraph(csvText) {
            const lines = csvText.trim().split('\n');
            const firstLine = lines[0];
            const sep = firstLine.includes(';') ? ';' : ',';

            const projects = [];
            const links = [];
            
            // Maps to track roles and connections
            const entityMap = new Map();

            const regex = new RegExp(`(?:^|${sep})(?:"([^"]*)"|([^${sep}]*))`, 'g');

            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;

                let matches = [];
                let match;
                regex.lastIndex = 0;
                while ((match = regex.exec(line)) !== null) {
                    let val = match[1] !== undefined ? match[1] : match[2];
                    matches.push(val ? val.trim() : "");
                }

                if (matches.length >= 3) {
                    const acronym = matches[0].trim();
                    const coordName = matches[1].trim();
                    let rawPartners = matches[2];
                    const money = parseFloat(matches[3].replace(/[^\d.-]/g, '')) || 0;
                    const desc = matches[4] || "";
                    const year = matches[5] || "";

                    // 1. Create Project Node
                    projects.push({
                        id: acronym,
                        type: 'project',
                        money: money,
                        desc: desc,
                        year: year,
                        radius: 20 + (Math.log(money + 1) / 2)
                    });

                    // 2. Process Coordinator
                    if (coordName) {
                        const cEntry = entityMap.get(coordName) || { isCoordinator: false, count: 0 };
                        cEntry.isCoordinator = true;
                        cEntry.count += 1;
                        entityMap.set(coordName, cEntry);

                        links.push({
                            source: acronym,
                            target: coordName,
                            value: 2 
                        });
                    }

                    // 3. Process Partners
                    if (rawPartners.startsWith('"') && rawPartners.endsWith('"')) rawPartners = rawPartners.slice(1, -1);
                    const partners = rawPartners.split(/,/).map(p => p.trim()).filter(p => p.length > 0);

                    partners.forEach(pName => {
                        if (pName === coordName) return;

                        const pEntry = entityMap.get(pName) || { isCoordinator: false, count: 0 };
                        pEntry.count += 1;
                        entityMap.set(pName, pEntry);

                        links.push({
                            source: acronym,
                            target: pName,
                            value: 1
                        });
                    });
                }
            }

            // CRITICAL FIX: Create a set of Project IDs to prevent duplicates
            // This prevents creating a Partner node if a Project node with the same name already exists
            const projectIds = new Set(projects.map(p => p.id));

            // Create nodes for Coordinators & Partners, FILTERING out those that are already Projects
            const otherNodes = Array.from(entityMap.entries())
                .filter(([name]) => !projectIds.has(name)) 
                .map(([name, data]) => {
                    const dynamicRadius = 5 + (Math.sqrt(data.count) * 3);
                    return {
                        id: name,
                        type: data.isCoordinator ? 'coordinator' : 'partner',
                        radius: dynamicRadius,
                        count: data.count
                    };
                });

            return {
                nodes: [...projects, ...otherNodes],
                links: links
            };
        }

        // --- 3. D3 Initialization & Clearing ---
        function initGraph() {
            // FIX: Using standard DOM manipulation to clear the container properly
            const container = document.getElementById("graph-container");
            if (container) {
                container.innerHTML = "";
            }

            svg = d3.select("#graph-container")
                .append("svg")
                .attr("width", "100%")
                .attr("height", "100%")
                .attr("viewBox", [0, 0, width, height])
                .on("click", (e) => {
                    if (e.target.tagName === 'svg') closePanel();
                });

            const defs = svg.append("defs");
            const filter = defs.append("filter").attr("id", "glow");
            filter.append("feGaussianBlur").attr("stdDeviation", "2.5").attr("result", "coloredBlur");
            const feMerge = filter.append("feMerge");
            feMerge.append("feMergeNode").attr("in", "coloredBlur");
            feMerge.append("feMergeNode").attr("in", "SourceGraphic");

            g = svg.append("g");

            zoom = d3.zoom()
                .scaleExtent([0.1, 6])
                .on("zoom", (event) => g.attr("transform", event.transform));
            svg.call(zoom);

            simulation = d3.forceSimulation()
                .force("link", d3.forceLink().id(d => d.id).distance(120))
                .force("charge", d3.forceManyBody().strength(-400))
                .force("center", d3.forceCenter(width / 2, height / 2))
                .force("collide", d3.forceCollide().radius(d => d.radius + 8).iterations(3));
        }

        // --- 4. Rendering ---
        function updateGraph(data) {
            globalData = data;
            
            const datalist = document.getElementById('nodes-datalist');
            datalist.innerHTML = data.nodes
                .sort((a,b) => a.id.localeCompare(b.id))
                .map(n => `<option value="${n.id}">${n.type === 'project' ? 'Project' : (n.type === 'coordinator' ? 'Coordinator' : 'Partner')}</option>`)
                .join('');

            document.getElementById('count-projects').innerText = data.nodes.filter(n => n.type === 'project').length;
            document.getElementById('count-coordinators').innerText = data.nodes.filter(n => n.type === 'coordinator').length;
            document.getElementById('count-partners').innerText = data.nodes.filter(n => n.type === 'partner').length;

            link = g.selectAll(".link")
                .data(data.links)
                .join("line")
                .attr("class", "link")
                .attr("stroke", colorLink)
                .attr("stroke-opacity", d => d.value === 2 ? 0.6 : 0.3)
                .attr("stroke-width", d => d.value === 2 ? 1.5 : 1);

            // Use Key function for data binding to ensure identity
            node = g.selectAll(".node")
                .data(data.nodes, d => d.id) 
                .join("g")
                .attr("class", "node")
                .attr("id", d => "node-" + d.id.replace(/\s+/g, '-').replace(/[^\w-]/g, '')) 
                .call(d3.drag()
                    .on("start", dragstarted)
                    .on("drag", dragged)
                    .on("end", dragended));

            node.append("circle")
                .attr("r", d => d.radius)
                .attr("fill", d => {
                    if (d.type === 'project') return colorProject;
                    if (d.type === 'coordinator') return colorCoordinator;
                    return colorPartner;
                })
                .attr("stroke", d => d.type === 'project' ? "#fff" : "none")
                .attr("stroke-width", d => d.type === 'project' ? 2 : 0)
                .attr("opacity", 0.9)
                .style("filter", d => d.type === 'project' ? "url(#glow)" : "")
                .on("mouseover", handleMouseOver)
                .on("mouseout", handleMouseOut)
                .on("click", (e, d) => {
                    e.stopPropagation();
                    handleClick(e, d);
                });

            const textGroup = node.append("text")
                .attr("dy", d => -d.radius - 10)
                .attr("text-anchor", "middle")
                .style("pointer-events", "none")
                .style("text-shadow", "0 2px 4px rgba(0,0,0,0.8)");

            textGroup.append("tspan")
                .text(d => d.type === 'project' ? d.id : "")
                .attr("fill", "#e2e8f0")
                .attr("font-weight", "600")
                .attr("font-size", "12px");

            textGroup.append("tspan")
                .text(d => d.type === 'project' ? ` ${formatMoneyShort(d.money)}` : "")
                .attr("fill", "#34d399") 
                .attr("font-weight", "400")
                .attr("font-size", "11px")
                .attr("dx", "4");

            simulation.nodes(data.nodes).on("tick", ticked);
            simulation.force("link").links(data.links);
            simulation.alpha(1).restart();
        }

        function ticked() {
            link
                .attr("x1", d => d.source.x)
                .attr("y1", d => d.source.y)
                .attr("x2", d => d.target.x)
                .attr("y2", d => d.target.y);

            node
                .attr("transform", d => `translate(${d.x},${d.y})`);
        }

        // --- 5. Interactions & Search ---

        function handleSearch(val) {
            if (!val) return;
            const target = globalData.nodes.find(n => n.id.toLowerCase() === val.toLowerCase()) || 
                           globalData.nodes.find(n => n.id.toLowerCase().includes(val.toLowerCase()));

            if (target) {
                focusOnNode(target);
                handleClick(null, target);
            }
        }

        function focusOnNode(d) {
            const scale = 2.5;
            const x = -d.x * scale + window.innerWidth / 2;
            const y = -d.y * scale + window.innerHeight / 2;

            svg.transition().duration(1000)
                .call(zoom.transform, d3.zoomIdentity.translate(x, y).scale(scale));

            d3.selectAll('.node').classed('node-highlight', false);
            const safeId = "#node-" + d.id.replace(/\s+/g, '-').replace(/[^\w-]/g, '');
            d3.select(safeId).classed('node-highlight', true);
            
            setTimeout(() => {
                d3.select(safeId).classed('node-highlight', false);
            }, 3000);
        }

        function dragstarted(event, d) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
        }
        function dragged(event, d) {
            d.fx = event.x;
            d.fy = event.y;
        }
        function dragended(event, d) {
            if (!event.active) simulation.alphaTarget(0);
            d.fx = null;
            d.fy = null;
        }

        function handleMouseOver(event, d) {
            let typeLabel = 'Partner';
            let colorClass = 'cyan-400';
            
            if (d.type === 'project') {
                typeLabel = 'R&D Project';
                colorClass = 'fuchsia-400';
            } else if (d.type === 'coordinator') {
                typeLabel = 'Coordinator';
                colorClass = 'amber-500';
            }

            const tooltip = d3.select("#tooltip");
            tooltip.style("display", "block")
                .style("left", (event.pageX + 15) + "px")
                .style("top", (event.pageY - 15) + "px")
                .html(`
                    <div class="font-bold text-${colorClass} mb-1">${d.id}</div>
                    <div class="text-xs text-gray-400 uppercase tracking-wider">${typeLabel}</div>
                    ${d.type !== 'project' ? `<div class="text-[10px] text-gray-500 mt-1">Involved in ${d.count} projects</div>` : ''}
                `);

            const connectedLinks = globalData.links.filter(l => l.source.id === d.id || l.target.id === d.id);
            const connectedNodeIds = new Set();
            connectedLinks.forEach(l => {
                connectedNodeIds.add(l.source.id);
                connectedNodeIds.add(l.target.id);
            });

            node.transition().duration(200).style("opacity", n => 
                (n.id === d.id || connectedNodeIds.has(n.id)) ? 1 : 0.1
            );
            link.transition().duration(200).style("stroke-opacity", l => 
                (l.source.id === d.id || l.target.id === d.id) ? 0.8 : 0.05
            ).style("stroke", l => 
                (l.source.id === d.id || l.target.id === d.id) ? "#fff" : colorLink
            );
            
            if(d.type === 'partner' || d.type === 'coordinator') {
                d3.select(event.target.parentNode).append("text")
                    .attr("class", "partner-hover-text")
                    .attr("dy", -d.radius - 5)
                    .attr("text-anchor", "middle")
                    .text(d.id)
                    .attr("fill", "#fff")
                    .attr("font-size", "10px");
            }
        }

        function handleMouseOut(event, d) {
            d3.select("#tooltip").style("display", "none");
            node.transition().duration(300).style("opacity", 0.9);
            link.transition().duration(300).style("stroke-opacity", d => d.value === 2 ? 0.6 : 0.3).style("stroke", colorLink);
            d3.select(event.target.parentNode).select(".partner-hover-text").remove();
        }

        function handleClick(event, d) {
            const panel = document.getElementById('details-panel');
            const content = document.getElementById('panel-content');
            
            panel.classList.remove('translate-x-[120%]');

            if (d.type === 'project') {
                const moneyFmt = new Intl.NumberFormat('en-IE', { style: 'currency', currency: 'EUR' }).format(d.money);
                const partners = globalData.links
                    .filter(l => l.source.id === d.id)
                    .map(l => l.target.id)
                    .sort();

                content.innerHTML = `
                    <div class="border-b border-gray-700 pb-4">
                        <span class="px-2 py-1 rounded bg-fuchsia-900/50 text-fuchsia-300 text-xs border border-fuchsia-500/30 uppercase tracking-wide">Project</span>
                        <h2 class="text-3xl font-bold text-white mt-2 leading-tight">${d.id}</h2>
                        <p class="text-gray-400 text-sm mt-3 leading-relaxed">${d.desc}</p>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3">
                        <div class="bg-gray-800/40 p-3 rounded-lg border border-white/5">
                            <p class="text-[10px] text-gray-500 uppercase tracking-wider mb-1">Budget</p>
                            <p class="text-base font-mono text-emerald-400 font-bold">${moneyFmt}</p>
                        </div>
                        <div class="bg-gray-800/40 p-3 rounded-lg border border-white/5">
                            <p class="text-[10px] text-gray-500 uppercase tracking-wider mb-1">Year</p>
                            <p class="text-base text-white font-bold">${d.year}</p>
                        </div>
                    </div>

                    <div class="flex-1 overflow-hidden flex flex-col">
                        <h3 class="text-xs font-bold text-gray-500 mb-3 uppercase tracking-wider">Collaborators (${partners.length})</h3>
                        <div class="flex flex-wrap gap-2 overflow-y-auto pr-2 custom-scroll">
                            ${partners.map(p => `<button onclick="handleSearch('${p}')" class="px-2 py-1 text-xs bg-cyan-900/20 text-cyan-200 border border-cyan-500/20 rounded hover:bg-cyan-500/20 hover:border-cyan-400 transition-all text-left">${p}</button>`).join('')}
                        </div>
                    </div>
                `;
            } else {
                const projects = globalData.links
                    .filter(l => l.target.id === d.id)
                    .map(l => l.source.id)
                    .sort();
                
                const typeLabel = d.type === 'coordinator' ? 'Coordinator' : 'Partner';
                const bgClass = d.type === 'coordinator' ? 'bg-amber-900/50 text-amber-300 border-amber-500/30' : 'bg-cyan-900/50 text-cyan-300 border-cyan-500/30';

                content.innerHTML = `
                    <div class="border-b border-gray-700 pb-4">
                        <span class="px-2 py-1 rounded ${bgClass} text-xs border uppercase tracking-wide">${typeLabel}</span>
                        <h2 class="text-2xl font-bold text-white mt-2 leading-tight">${d.id}</h2>
                    </div>

                    <div>
                        <h3 class="text-xs font-bold text-gray-500 mb-3 uppercase tracking-wider">Participates in (${projects.length}) Projects</h3>
                        <ul class="space-y-2">
                            ${projects.map(proj => `
                                <li class="group flex items-center p-2 rounded bg-gray-800/30 hover:bg-gray-800/80 border border-white/5 hover:border-fuchsia-500/30 transition-all cursor-pointer" onclick="handleSearch('${proj}')">
                                    <span class="w-2 h-2 rounded-full bg-fuchsia-500 mr-3 group-hover:scale-125 transition-transform"></span>
                                    <span class="text-sm text-gray-200 group-hover:text-white">${proj}</span>
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                `;
            }
        }

        function closePanel() {
            document.getElementById('details-panel').classList.add('translate-x-[120%]');
        }

        function resetZoom() {
            svg.transition().duration(750).call(
                zoom.transform,
                d3.zoomIdentity,
                d3.zoomTransform(svg.node()).invert([width / 2, height / 2])
            );
            closePanel();
        }

        document.getElementById('csvInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                const graphData = parseCSVAndBuildGraph(text);
                
                // FIX: Clean the graph before updating to prevent "shadow nodes"
                initGraph();
                
                updateGraph(graphData);
            };
            reader.readAsText(file);
            
            // Allow re-uploading the same file if needed
            e.target.value = ''; 
        });

        initGraph();
        updateGraph(parseCSVAndBuildGraph(sampleCSV));

        window.addEventListener('resize', () => {
            svg.attr("viewBox", [0, 0, window.innerWidth, window.innerHeight]);
            simulation.force("center", d3.forceCenter(window.innerWidth / 2, window.innerHeight / 2));
            simulation.alpha(0.3).restart();
        });

    </script>
</body>
</html>